<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Assessor scoring page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/print.css" media="print">

  </head>
  <body>
    <div class="container my-4">
      <h1 class="mb-4">
        Evaluation Portal - Assessment Scoring<br>
        <small class="text-muted">{{ assessment.name }}</small>
      </h1>
      <p class="hide-from-print-summary">
        Please score each criteria 0-10 for every application, along with comments to justify your scoring. Scores and comments will automatically save as you enter them. Each session will expire after 24 hours but you may exit and re-enter the portal using your unique URL and access code at any time, to continue scoring.  
      </p>
      <p class="hide-from-print-summary">
        Access each application in full by following the ‚ÄúAccess the panel folder‚Äù link below to SharePoint. The panel folder also contains supporting documentation such as the evaluation plan, weighted criteria guidance, the panel briefing and tender documentation.  
      </p>
      <ul class="hide-from-print-summary">
      {% if assessment.sharepoint_dir %}      
        <li><a href="{{ assessment.sharepoint_dir }}" target="_blank">Access the panel folder</a></li>
      {% endif %}
      {% if assessment.pdf_score_filename %}
        <li><a href="{{ url_for('uploaded_file', filename=assessment.pdf_score_filename) }}" target="_blank">Download the evaluation plan</a></li>
      {% endif %}
      </ul>
      <div class="row">
        <div class="col-md-12">
          <div class="float-end hide-from-print-summary mb-2">

                <!-- PDF view switch -->
                <div class="btn-group btn-group-sm" role="group" aria-label="PDF view">
                  {% if assessment.map_url %}
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnMap"
                    data-mode="map"
                  >
                    View map
                  </button>
                  {% endif %}
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnAssessment"
                    data-mode="assessment"
                    {% if not assessment.pdf_filename %}disabled{% endif %}
                  >
                    Assessment tool
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnGuide"
                    data-mode="guide"
                    {% if not assessment.pdf_score_filename %}disabled{% endif %}
                  >
                    Evaluation plan
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnHide"
                    data-mode="hide"
                  >
                    Hide both
                  </button>
                </div>

              </div>
        </div>
        <div id="scoringCol" class="col-md-5">
          <form method="POST" action="{{ url_for('score', token=token) }}">
            <!-- Accordion to collapse each application section -->
            <div class="accordion" id="appAccordion">
            {% for app in applications %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ app.id }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ app.id }}" aria-expanded="false" aria-controls="collapse-{{ app.id }}">
                    <strong>Applicant {{ app.code }}</strong>
                    <span class="small">
                      &nbsp; Weighted Score: <span id="weighted-{{ app.id }}">{{ weighted_scores[app.id] }}</span><br>
                      &nbsp; <span class="text-muted" id="progress-{{ app.id }}">0/{{ criteria|length }} scores completed</span>
                    </span>
                  </button>
                </h2>
                <div id="collapse-{{ app.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ app.id }}" data-bs-parent="#appAccordion">
                  <div class="accordion-body">
                    {% for crit in criteria %}
                    {% set key = app.id ~ '-' ~ crit.id %}
                      <div class="mb-3">
                        <label for="score-{{ app.id }}-{{ crit.id }}">
                          <strong>{{ crit.description }}</strong> <span style="color: #666;">(weighted {{ crit.weight }}%)</span><br>
                          <small><em>Provide a score of 0-10 for {{ crit.description }}</em></small>
                        </label>
                        <input 
                          type="number"
                          class="form-control mb-2"
                          name="score-{{ app.id }}-{{ crit.id }}"
                          id="score-{{ app.id }}-{{ crit.id }}"
                          min="0"
                          max="10"
                          step="1"
                          value="{{ score_dict[key].score if key in score_dict else '' }}"
                          {% if key in score_dict and score_dict[key].finalised %}disabled{% endif %}
                          >
                        <label for="comment-{{ app.id }}-{{ crit.id }}" class="hide-from-print-summary">
                          <small><em>Provide comments for {{ crit.description }}</em></small>
                        </label>
                        <textarea
                          placeholder="Your comments"
                          class="form-control auto-resize-textarea"
                          name="comment-{{ app.id }}-{{ crit.id }}"
                          id="comment-{{ app.id }}-{{ crit.id }}"
                          rows="2"
                          {% if key in score_dict and score_dict[key].finalised %}disabled{% endif %}
                        >{{ score_dict[key].comment if key in score_dict else '' }}</textarea>
                      </div>
                      <hr>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
            </div>
            <div class="mt-3">
              <div class="d-flex justify-content-end hide-from-print-summary">
                <button 
                  class="btn btn-outline-secondary btn-sm me-2" 
                  onclick="window.print()"
                  >
                  üñ®Ô∏è Summary view
                </button>

                <button
                  type="submit"
                  id="finaliseBtn"
                  name="action"
                  value="finalise"
                  class="btn btn-primary btn-sm"
                  onclick="return confirm('Once you submit and finalise, this cannot be undone and your scores are final. Are you sure you want to proceed?');" 
                >
                  Submit and finalise your score
                </button>
              </div>
            </div>
          </form>
        </div>
        <div
          id="pdfCol"
          class="col-md-7 hide-from-print-summary"
          data-assessment-url="{{ url_for('uploaded_file', filename=assessment.pdf_filename) if assessment.pdf_filename else '' }}"
          data-guide-url="{{ url_for('uploaded_file', filename=assessment.pdf_score_filename) if assessment.pdf_score_filename else '' }}"
          data-map-url="{{ assessment.map_url or '' }}"
        >
          <iframe id="pdfFrame" width="100%" height="1200px" class="border" title="Reference PDF"></iframe>
          <div id="pdfMissing" class="alert alert-warning m-2 d-none">
            The selected document isn‚Äôt available for this assessment.
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="alert alert-info py-1 px-2 d-flex align-items-center justify-content-between hide-from-print-summary">
        <div>
            <strong>Session time remaining:</strong>
            <span id="session-timer">24:00:00</span>
        </div>
        <small class="text-muted ms-2">
          After this time changes will no longer auto-save and you will need to log back in.
        </small>
      </div>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <!-- Modal -->
        <div class="modal fade" id="submissionModal" tabindex="-1" aria-labelledby="submissionModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="submissionModalLabel">Submission Received</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {{ messages[0] }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endwith %}

    <!-- Session expired modal -->
    <div class="modal fade" id="sessionExpiredModal" tabindex="-1"
        aria-labelledby="sessionExpiredModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sessionExpiredModalLabel">Session expired</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Your scoring page has been open for more than 24 hours. For security reasons,
            your login session may have expired.
            <ul>
              <li>Any scores you enter from now on may not be saved.</li>
              <li>Please copy any notes you need, then refresh this page using your original access link.</li>
            </ul>
          </div>
          <div class="modal-footer">
            <a href="" class="btn btn-primary" id="sessionRefreshLink">Refresh now</a>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              I'll refresh later
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      // Show "submission received" modal if it exists
      document.addEventListener("DOMContentLoaded", function(){
        var submissionModalEl = document.getElementById('submissionModal');
        if (submissionModalEl && window.bootstrap) {
          var submissionModal = new bootstrap.Modal(submissionModalEl);
          submissionModal.show();
        }
      });

      document.getElementById('finaliseBtn')?.addEventListener('click', function(){
        document.querySelectorAll('.accordion-collapse').forEach(panel=>{
          new bootstrap.Collapse(panel, { toggle: false }).show();
        });
      });

      // build the autosave URL once
      const autosaveUrl = "{{ url_for('autosave_score', token=token) }}";
      // global flag to stop autosave after session expiry
      window.sessionExpired = false;

      // helper to POST JSON
      async function autosave(payload){
        if (window.sessionExpired) {
          console.warn('Skipping autosave because session is marked as expired.');
          return;
        }
        try {
          let res = await fetch(autosaveUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            let err = await res.json();
            console.error('Autosave error:', err);
          }
        } catch(e) {
          console.error('Autosave failed:', e);
        }
      }

      // now Jinja just dumps a JSON literal
      const critWeights    = {{ crit_weights  | tojson }};
      const initialScores  = {{ weighted_scores | tojson }};

      // set initial display
      document.addEventListener('DOMContentLoaded', () => {
        for (const [appId, ws] of Object.entries(initialScores)) {
          const span = document.getElementById(`weighted-${appId}`);
          if (span && typeof ws === 'number') span.textContent = ws.toFixed(2);
        }
      });

      function recalcProgress(appId) {
        const inputs = document.querySelectorAll(`input[name^="score-${appId}-"]`);
        const total = inputs.length;

        let done = 0;
        inputs.forEach(input => {
          // treat blank as not done; treat 0..10 as done
          const v = input.value;
          if (v !== '' && v !== null && !isNaN(parseInt(v, 10))) done++;
        });

        const el = document.getElementById(`progress-${appId}`);
        if (el) el.textContent = `${done}/${total} scores completed`;
      }

      // attach blur listeners to every score input and every comment textarea
      document.querySelectorAll(
          'input[name^="score-"], textarea[name^="comment-"]'
        ).forEach(el => {
        el.addEventListener('blur', function(){
          // name is "score-<appId>-<critId>" or "comment-<appId>-<critId>"
          let [type, appId, critId] = this.name.split('-');
          let scoreField   = document.querySelector(`input[name="score-${appId}-${critId}"]`);
          let commentField = document.querySelector(`textarea[name="comment-${appId}-${critId}"]`);

          autosave({
            application_id: parseInt(appId, 10),
            criteria_id:    parseInt(critId, 10),
            score:          scoreField   ? scoreField.value   : null,
            comment:        commentField ? commentField.value : null
          });

          recalcApp(appId);
          recalcProgress(appId);
        });
      });

      document.addEventListener('DOMContentLoaded', function(){
        const scoringCol = document.getElementById('scoringCol');
        const pdfCol     = document.getElementById('pdfCol');
        const pdfFrame   = document.getElementById('pdfFrame');
        const pdfMissing = document.getElementById('pdfMissing');

      const urls = {
        assessment: pdfCol?.dataset.assessmentUrl || '',
        guide:      pdfCol?.dataset.guideUrl || '',
        map:        pdfCol?.dataset.mapUrl || ''
      };

        // Buttons
        const btnAssessment = document.getElementById('btnAssessment');
        const btnGuide      = document.getElementById('btnGuide');
        const btnMap        = document.getElementById('btnMap');
        const btnHide       = document.getElementById('btnHide');
        const btns = [btnAssessment, btnGuide, btnMap, btnHide];

        function setActive(mode) {
          btns.forEach(b => {
            if (!b) return;
            const isActive = b.dataset.mode === mode;
            b.classList.toggle('btn-secondary', isActive);
            b.classList.toggle('btn-outline-secondary', !isActive);
            b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
        }

        function setLayout(hidden) {
          pdfCol.classList.toggle('d-none', hidden);
          scoringCol.classList.toggle('col-md-5', !hidden);
          scoringCol.classList.toggle('col-md-12', hidden);
        }

        function showMissing() {
          pdfFrame.removeAttribute('src');
          pdfMissing.classList.remove('d-none');
          setLayout(false); // still show right column, but with message
        }

        function setMode(mode) {
          setActive(mode);
          pdfMissing.classList.add('d-none');

          if (mode === 'hide') {
            pdfFrame.removeAttribute('src');
            setLayout(true);
            return;
          }

          const src = urls[mode] || '';
          if (!src) {
            showMissing();
            return;
          }

          // Show iframe with the chosen doc
          pdfFrame.src = src;
          setLayout(false);
        }

        // Wire buttons
        btns.forEach(b => b && b.addEventListener('click', () => setMode(b.dataset.mode)));

        // Initial mode: prefer Assessment, then Guide, else Hide
        const initialMode = urls.assessment ? 'assessment' : (urls.guide ? 'guide' : 'hide');
        setMode(initialMode);
      });

      document.addEventListener('DOMContentLoaded', () => {
        // auto-resize remarks textareas
        document.querySelectorAll('.auto-resize-textarea').forEach(textarea => {
          textarea.style.height = textarea.scrollHeight + 'px';
          textarea.style.overflowY = 'hidden';

          textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
          });
        });
      });

      document.addEventListener('DOMContentLoaded', () => {
        // initialise progress for each appId we can see in the DOM
        document.querySelectorAll('input[name^="score-"]').forEach(input => {
          const [, appId] = input.name.split('-'); // "score-<appId>-<critId>"
          recalcProgress(appId);
        });
      });

      // -------------------------
      // Session countdown (24 hrs)
      // Uses localStorage so refreshes don't reset it
      // -------------------------
      document.addEventListener('DOMContentLoaded', () => {
        const SESSION_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours
        const timerEl = document.getElementById('session-timer');
        if (!timerEl) return;

        const token = "{{ token }}";   // unique per scoring page
        const LS_KEY = `scoringTimer_${token}`;

        const refreshLink = document.getElementById('sessionRefreshLink');
        if (refreshLink) {
          refreshLink.href = window.location.href;
        }

        const expiredModalEl = document.getElementById('sessionExpiredModal');
        let expiredModal = null;
        if (expiredModalEl && window.bootstrap) {
          expiredModal = new bootstrap.Modal(expiredModalEl);
        }

        function handleExpired() {
          if (window.sessionExpired) return;
          window.sessionExpired = true;

          // disable UI
          document.querySelectorAll('input[name^="score-"], textarea[name^="comment-"]').forEach(el => {
            el.setAttribute('disabled', 'disabled');
          });
          document.getElementById('finaliseBtn')?.setAttribute('disabled', 'disabled');

          // show modal
          if (expiredModal) expiredModal.show();
        }

        function formatTime(ms) {
          const totalSeconds = Math.max(0, Math.floor(ms / 1000));
          const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
          const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
          const s = String(totalSeconds % 60).padStart(2, '0');
          return `${h}:${m}:${s}`;
        }

        // --- load or create session info ---
        let sessionData = null;
        try {
          sessionData = JSON.parse(localStorage.getItem(LS_KEY));
        } catch (_) {}

        const now = Date.now();

        if (!sessionData || !sessionData.expiry || now > sessionData.expiry) {
          // session missing or already expired ‚Üí start a fresh 24h window
          const start = now;
          const expiry = start + SESSION_DURATION_MS;
          sessionData = { start, expiry };
          localStorage.setItem(LS_KEY, JSON.stringify(sessionData));
        }

        // If user loads after expiry, show expired immediately
        if (now >= sessionData.expiry) {
          timerEl.textContent = "00:00:00";
          handleExpired();
          return;
        }

        // --- normal countdown ---
        const intervalId = setInterval(() => {
          const remaining = sessionData.expiry - Date.now();
          if (remaining <= 0) {
            timerEl.textContent = "00:00:00";
            clearInterval(intervalId);
            handleExpired();
            return;
          }
          timerEl.textContent = formatTime(remaining);
        }, 1000);

        // initial render
        timerEl.textContent = formatTime(sessionData.expiry - now);
      });
    </script>

  </body>
</html>
