<div id="publishSummary">
  {% if selected_assessment %}

    <h2>Application Breakdown</h2>

    {# --- Application breakdown: one table, apps sorted by avg_weighted desc already --- #}
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th style="width: 180px;">Application</th>
          <th class="text-end" style="width: 120px;">Avg Score</th>
          <th class="text-end" style="width: 80px;">Rank</th>

          {# one pair of columns per assessor (score only, or score+rank if you want) #}
          {% for row0 in app_breakdown[0].assessors if app_breakdown and app_breakdown[0].assessors %}
            <th class="text-end">{{ row0.assessor.name }} score</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for ab in app_breakdown %}
          <tr>
            <td>
              <strong>{{ ab.application.code }}</strong>
              {% if ab.application.name %}
                <div class="text-muted small">{{ ab.application.name }}</div>
              {% endif %}
            </td>

            <td class="text-end">
              {{ (ab.avg_weighted * 10) | round(2) }} / 100
            </td>

            <td class="text-end">
              {{ loop.index }}
            </td>

            {# assessor totals per app (ab.assessors already holds total_weighted) #}
            {% for r in ab.assessors %}
              <td class="text-end">
                {{ (r.total_weighted * 10) | round(2) }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr>

    <h2>Panel-Member Breakdown</h2>

    {% for pb in panel_breakdown %}
      <h3 style="margin-top: 1.25rem;">{{ pb.assessor.name }}</h3>

      {# One table per assessor, apps stacked vertically #}
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th style="width: 180px;">Application</th>
            <th>Criteria</th>
            <th class="text-end" style="width: 90px;">Raw</th>
            <th class="text-end" style="width: 140px;">Weighted</th>
          </tr>
        </thead>
        <tbody>

          {% for blk in pb.by_application %}
            {% set app = blk.application %}
            {% set total_w = blk.criteria_items | sum(attribute='weighted') %}

            {# app header row #}
            <tr class="table-secondary">
              <td colspan="4">
                <strong>{{ app.code }}</strong>
                <span class="text-muted"> â€” Total: {{ (total_w * 10) | round(2) }} / 100</span>
              </td>
            </tr>

            {# criteria rows #}
            {% for ci in blk.criteria_items %}
              <tr>
                <td></td>
                <td>
                  {{ ci.criteria.description }}
                  <small class="text-muted">({{ ci.criteria.weight }}%)</small>
                </td>
                <td class="text-end">{{ ci.score }} / 10</td>
                <td class="text-end">{{ (ci.weighted * 10) | round(2) }} / {{ ci.criteria.weight }}</td>
              </tr>
            {% endfor %}

            {# comments block (only if any) #}
            {% set any_comments = blk.criteria_items | selectattr('comment') | list | length > 0 %}
            {% if any_comments %}
              <tr>
                <td></td>
                <td colspan="3">
                  <strong>Comments</strong>
                  <div style="margin-top: .25rem;">
                    {% for ci in blk.criteria_items %}
                      {% if ci.comment %}
                        <div style="margin-bottom: .5rem;">
                          <div><strong>{{ ci.criteria.description }}</strong></div>
                          <div class="text-muted">{{ ci.comment }}</div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </td>
              </tr>
            {% endif %}

          {% endfor %}
        </tbody>
      </table>

    {% endfor %}

  {% endif %}
</div>